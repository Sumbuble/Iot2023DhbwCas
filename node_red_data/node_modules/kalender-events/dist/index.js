var Le=Object.create;var V=Object.defineProperty,$e=Object.defineProperties,Ke=Object.getOwnPropertyDescriptor,Ve=Object.getOwnPropertyDescriptors,Fe=Object.getOwnPropertyNames,ue=Object.getOwnPropertySymbols,Je=Object.getPrototypeOf,fe=Object.prototype.hasOwnProperty,qe=Object.prototype.propertyIsEnumerable;var ce=(e,t,r)=>t in e?V(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r,pe=(e,t)=>{for(var r in t||(t={}))fe.call(t,r)&&ce(e,r,t[r]);if(ue)for(var r of ue(t))qe.call(t,r)&&ce(e,r,t[r]);return e},ge=(e,t)=>$e(e,Ve(t)),me=e=>V(e,"__esModule",{value:!0});var He=(e,t)=>{me(e);for(var r in t)V(e,r,{get:t[r],enumerable:!0})},We=(e,t,r)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Fe(t))!fe.call(e,a)&&a!=="default"&&V(e,a,{get:()=>t[a],enumerable:!(r=Ke(t,a))||r.enumerable});return e},O=e=>We(me(V(e!=null?Le(Je(e)):{},"default",e&&e.__esModule&&"default"in e?{get:()=>e.default,enumerable:!0}:{value:e,enumerable:!0})),e);He(exports,{KalenderEvents:()=>X,getVersion:()=>yt});var b=O(require("moment")),re=O(require("uuid"));var x=O(require("moment")),ye=O(require("moment"));function W(e,t,r){let a=!1;if(e.duration)/(-)?P(?:([.,\d]+)Y)?(?:([.,\d]+)M)?(?:([.,\d]+)W)?(?:([.,\d]+)D)?(?:T(?:([.,\d]+)H)?(?:([.,\d]+)M)?(?:([.,\d]+)S)?)?/.test(e.duration)?a=(0,ye.duration)(e.duration).asSeconds()%86400==0:a=e.duration.toSeconds()%86400==0;else{var n=(r.getTime()-t.getTime())/1e3;n=Number(n),a=n%86400==0}return a}function ee(e,t){var a,n;if(!e.length)e.push(t);else if(e[0].eventStart>t.eventStart)e.unshift(t);else if(e[e.length-1].eventStart<(t==null?void 0:t.eventStart))e.push(t);else if(e.length===1)e.push(t);else{for(var r=0;r<e.length;r++)if(e[r].uid.uid==((a=t.uid)==null?void 0:a.uid)&&t.eventStart.getTime()==((n=e[r].eventStart)==null?void 0:n.getTime())){t=null;break}if(t){for(var r=0;r<e.length-1;r++)if(e[r].eventStart<=(t==null?void 0:t.eventStart)&&(t==null?void 0:t.eventStart)<e[r+1].eventStart){e.splice(r+1,0,t),t=null;break}}t&&e.push(t)}}function F(e){let t=e.toISOString();var r=(0,x.default)(t).utcOffset();return-r}function U(e){let t=new Date,r=new Date;e&&e.now&&(t=r=(0,x.default)(e.now).toDate());let a=(0,x.default)(t),n=x.default.duration(JSON.parse(`{"${e.previewUnits}" : "${e.preview===1&&e.previewUnits==="days"?e.preview-1:e.preview}" }`));if(typeof e.preview=="string"&&Number.isNaN(Number.parseInt(e.preview)))if(/^P(?!$)(\d+Y)?(\d+M)?(\d+W)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+S)?)?$/.test(e.preview))n=x.default.duration(e.preview);else throw new Error("preview must be a duration string or a number");else if(typeof e.preview=="number"&&!Number.isNaN(e.preview))n.days()>0||e.preview===1&&e.previewUnits==="days"?a=a.endOf("day"):n.hours()>0?a=a.endOf("hour"):n.minutes()>0?a=a.endOf("minute"):n.seconds()>0&&(a=a.endOf("second"));else throw new Error("preview must be a duration string or a number");let o=a.add(n),s=(0,x.default)(r),i=x.default.duration(JSON.parse(`{"${e.pastviewUnits}" : "${e.pastview===1&&e.pastviewUnits==="days"?e.pastview-1:e.pastview}" }`));if(typeof e.pastview=="string"&&Number.isNaN(Number.parseInt(e.pastview)))if(/^P(?!$)(\d+Y)?(\d+M)?(\d+W)?(\d+D)?(T(?=\d)(\d+H)?(\d+M)?(\d+S)?)?$/.test(e.pastview))i=x.default.duration(e.pastview);else throw new Error("pastview must be a duration string or a number");else if(typeof e.pastview=="number"&&!Number.isNaN(e.pastview))i.days()>0||e.pastview===1&&e.pastviewUnits==="days"?s=s.startOf("day"):i.hours()>0?s=s.startOf("hour"):i.minutes()>0?s=s.startOf("minute"):i.seconds()>0&&(s=s.startOf("second"));else throw new Error("pastview must be a duration string or a number");let f=s.subtract(i);return{preview:o,pastview:f}}var he=O(require("moment"));function L(e,t,r,a,n){if(!n.replacedates&&typeof Intl.DateTimeFormat=="function"){let T=new Intl.DateTimeFormat(n.language,n.dateformat);return r>=t?T.formatRange(t,r):T.formatRange(r,t)}var o=t.getDate(),s=t.getMonth()+1,i=t.getFullYear(),f=r.getDate(),l=r.getMonth()+1,d=r.getFullYear(),c="",g=t<new Date;let E=W(e,t,r);if(!n.replacedates&&a){let T=t.getHours().toString(),R=t.getMinutes().toString();g||(parseInt(T)<10&&(T="0"+T.toString()),parseInt(R)<10&&(R="0"+R.toString()),c=" "+T+":"+R);let K=r.getTime()-t.getTime();if(K===0&&parseInt(T)===0&&parseInt(R)===0)c=" ";else if(K>0){g?c+=" ":c+="-";let q=r.getHours().toString(),H=r.getMinutes().toString();parseInt(q)<10&&(q="0"+q.toString()),parseInt(H)<10&&(H="0"+H.toString()),c+=q+":"+H;let Ue=(0,he.default)(t).endOf("day").toDate();if(r>Ue){var y=new Date;g||(y.setDate(t.getDate()),y.setMonth(t.getMonth()),y.setFullYear(t.getFullYear())),y.setHours(0,0,1,0);var I=K;K=r.getTime()-y.getTime(),I>=24*60*60*1e3&&(c+="+"+Math.floor(K/(24*60*60*1e3)))}else n.replacedates&&r.getHours()===0&&r.getMinutes()===0&&(c=" ")}}var m="",u=new Date;u.setHours(0,0,0,0);var D=new Date;D.setDate(u.getDate()+1);var k=!1;if(o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&f===D.getDate()&&l===D.getMonth()+1&&d===D.getFullYear()&&E&&(k=!0),k||!g){if(o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&(m="today"),u.setDate(u.getDate()+1),o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&(m="tomorrow"),u.setDate(u.getDate()+1),o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&(m="dayafter"),u.setDate(u.getDate()+1),o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&(m="3days"),u.setDate(u.getDate()+1),o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&(m="4days"),u.setDate(u.getDate()+1),o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&(m="5days"),u.setDate(u.getDate()+1),o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&(m="6days"),u.setDate(u.getDate()+1),o===u.getDate()&&s===u.getMonth()+1&&i===u.getFullYear()&&(m="oneweek"),n.replacedates){if(m==="today")return p("today",n)+c;if(m==="tomorrow")return p("tomorrow",n)+c;if(m==="dayafter")return p("dayafter",n)+c;if(m==="3days")return p("3days",n)+c;if(m==="4days")return p("4days",n)+c;if(m==="5days")return p("5days",n)+c;if(m==="6days")return p("6days",n)+c;if(m==="oneweek")return p("oneweek",n)+c}}else{m="today";var w=Math.round((r.getDate()-new Date().getDate())/(1e3*60*60*24)),h=Math.round((r.getDate()-new Date().getDate())/(1e3*60*60));if(n.replacedates){var N=p("left",n)!==" "?" "+p("left",n):"",v;if(w===42)v=p("6week_left",n);else if(w===35)v=p("5week_left",n);else if(w===28)v=p("4week_left",n);else if(w===21)v=p("3week_left",n);else if(w===14)v=p("2week_left",n);else if(w===7)v=p("1week_left",n);else if(w>=1)if(n.language==="ru"){var $=w%10,_=Math.floor(w/10)%10;w===1?v=(p("still",n)!==" "?p("still",n):"")+" "+w+" "+p("day",n)+N:_>1&&($>1||$<5)?v=(p("still",n)!==" "&&p("still",n),n+" "+w+" "+"\u0434\u043D\u044F"+N):v=(p("still",n)!==" "?p("still",n):"")+" "+w+" "+p("days",n)+N}else v=(p("still",n)!==" "&&p("still",n),n+" "+w+" "+(p(w===1?"day":"days",n),n)+N);else if(n.language==="ru"){var $=h%10,_=Math.floor(h/10)%10;h===1?v=(p("still",n)!==" "?p("still",n):"")+" "+h+" "+p("hour",n)+N:_!==1&&($>1||$<5)?v=(p("still",n)!==" "&&p("still",n),n+" "+h+" "+"\u0447\u0430\u0441\u0430"+N):v=(p("still",n)!==" "?p("still",n):"")+" "+h+" "+p("hours",n)+N}else v=(p("still",n)!==" "?p("still",n):"")+" "+h+" "+p(h===1?"hour":"hours",n)+N}else if(o=r.getDate(),E&&(o-=1,a=!1),s=r.getMonth()+1,i=r.getFullYear(),o<10&&(o="0"+o.toString()),s<10&&(s="0"+s.toString()),v=o+"."+s+".",v+=i,a){let T=r.getHours().toString(),R=r.getMinutes().toString();parseInt(T)<10&&(T="0"+T.toString()),parseInt(R)<10&&(R="0"+R.toString()),v+=" "+T+":"+R}return v}return o<10&&(o="0"+o.toString()),s<10&&(s="0"+s.toString()),(o+"."+s+"."+i+c).trim()}function p(e,t){if(!e)return"";if(te[e]){var r=te[e][t.language];if(r)return r;if(t.language!=="en"&&(r=te[e].en,r))return r}return e}var te={today:{en:"Today",it:"Oggi",es:"Hoy",pl:"Dzisiaj",fr:"Aujourd'hui",de:"Heute",ru:"\u0421\u0435\u0433\u043E\u0434\u043D\u044F",nl:"Vandaag"},tomorrow:{en:"Tomorrow",it:"Domani",es:"Ma\xF1ana",pl:"Jutro",fr:"Demain",de:"Morgen",ru:"\u0417\u0430\u0432\u0442\u0440\u0430",nl:"Morgen"},dayafter:{en:"Day After Tomorrow",it:"Dopodomani",es:"Pasado ma\xF1ana",pl:"Pojutrze",fr:"Apr\xE8s demain",de:"\xDCbermorgen",ru:"\u041F\u043E\u0441\u043B\u0435\u0437\u0430\u0432\u0442\u0440\u0430",nl:"Overmorgen"},"3days":{en:"In 3 days",it:"In 3 giorni",es:"En 3 d\xEDas",pl:"W 3 dni",fr:"Dans 3 jours",de:"In 3 Tagen",ru:"\u0427\u0435\u0440\u0435\u0437 2 \u0434\u043D\u044F",nl:"Over 3 dagen"},"4days":{en:"In 4 days",it:"In 4 giorni",es:"En 4 d\xEDas",pl:"W 4 dni",fr:"Dans 4 jours",de:"In 4 Tagen",ru:"\u0427\u0435\u0440\u0435\u0437 3 \u0434\u043D\u044F",nl:"Over 4 dagen"},"5days":{en:"In 5 days",it:"In 5 giorni",es:"En 5 d\xEDas",pl:"W ci\u0105gu 5 dni",fr:"Dans 5 jours",de:"In 5 Tagen",ru:"\u0427\u0435\u0440\u0435\u0437 4 \u0434\u043D\u044F",nl:"Over 5 dagen"},"6days":{en:"In 6 days",it:"In 6 giorni",es:"En 6 d\xEDas",pl:"W ci\u0105gu 6 dni",fr:"Dans 6 jours",de:"In 6 Tagen",ru:"\u0427\u0435\u0440\u0435\u0437 5 \u0434\u043D\u0435\u0439",nl:"Over 6 dagen"},oneweek:{en:"In one week",it:"In una settimana",es:"En una semana",pl:"W jeden tydzie\u0144",fr:"Dans une semaine",de:"In einer Woche",ru:"\u0427\u0435\u0440\u0435\u0437 \u043D\u0435\u0434\u0435\u043B\u044E",nl:"Binnen een week"},"1week_left":{en:"One week left",it:"Manca una settimana",es:"Queda una semana",pl:"Zosta\u0142 jeden tydzie\u0144",fr:"Reste une semaine",de:"Noch eine Woche",ru:"\u0415\u0449\u0451 \u043D\u0435\u0434\u0435\u043B\u044F",nl:"Over een week"},"2week_left":{en:"Two weeks left",it:"Due settimane rimaste",es:"Dos semanas restantes",pl:"Zosta\u0142y dwa tygodnie",fr:"Il reste deux semaines",de:"Noch zwei Wochen",ru:"\u0415\u0449\u0451 \u0434\u0432\u0435 \u043D\u0435\u0434\u0435\u043B\u0438",nl:"Over twee weken"},"3week_left":{en:"Three weeks left",it:"Tre settimane rimanenti",es:"Tres semanas quedan",pl:"Pozosta\u0142y trzy tygodnie",fr:"Trois semaines restantes",de:"Noch drei Wochen",ru:"\u0415\u0449\u0451 \u0442\u0440\u0438 \u043D\u0435\u0434\u0435\u043B\u0438",nl:"Over drie weken"},"4week_left":{en:"Four weeks left",it:"Quattro settimane rimaste",es:"Cuatro semanas quedan",pl:"Pozosta\u0142y cztery tygodnie",fr:"Quatre semaines \xE0 gauche",de:"Noch vier Wochen",ru:"\u0415\u0449\u0451 \u0442\u0440\u0438 \u043D\u0435\u0434\u0435\u043B\u0438",nl:"Over vier weken"},"5week_left":{en:"Five weeks left",it:"Cinque settimane rimaste",es:"Quedan cinco semanas",pl:"Pozosta\u0142o pi\u0119\u0107 tygodni",fr:"Cinq semaines \xE0 gauche",de:"Noch f\xFCnf Wochen",ru:"\u0415\u0449\u0451 \u043F\u044F\u0442\u044C \u043D\u0435\u0434\u0435\u043B\u044C",nl:"Over vijf weken"},"6week_left":{en:"Six weeks left",it:"Sei settimane a sinistra",es:"Seis semanas restantes",pl:"Pozosta\u0142o sze\u015B\u0107 tygodni",fr:"Six semaines \xE0 gauche",de:"Noch sechs Wochen",ru:"\u0415\u0449\u0451 \u0448\u0435\u0441\u0442\u044C \u043D\u0435\u0434\u0435\u043B\u044C",nl:"Over zes weken"},left:{en:"left",it:"sinistra",es:"izquierda",pl:"lewo",fr:"la gauche",de:" ",ru:"\u043E\u0441\u0442\u0430\u043B\u043E\u0441\u044C",nl:"over"},still:{en:"",it:"",es:"",pl:"",fr:"",de:"Noch",ru:"",nl:"nog"},days:{en:"days",it:"Giorni",es:"dias",pl:"dni",fr:"journ\xE9es",de:"Tage",ru:"\u0434\u043D\u0435\u0439",nl:"dagen"},day:{en:"day",it:"giorno",es:"d\xEDa",pl:"dzie\u0144",fr:"journ\xE9e",de:"Tag",ru:"\u0434\u0435\u043D\u044C",nl:"dag"},hours:{en:"hours",it:"ore",es:"horas",pl:"godziny",fr:"heures",de:"Stunden",ru:"\u0447\u0430\u0441\u043E\u0432",nl:"uren"},hour:{en:"hour",it:"ora",es:"hora",pl:"godzina",fr:"heure",de:"Stunde",ru:"\u0447\u0430\u0441",nl:"uur"}};var ne=require("debug")("kalender-events:convert");function j(e,t){let r=[];if(e)if(ne(`convertEvents - events: ${JSON.stringify(e)}`),Array.isArray(e))e.forEach(a=>{let n=Be(a.data,t);n&&r.push(n)});else if(e.events||e.occurrences)e.events&&e.events.forEach(a=>{let n=P(a,t);n&&r.push(n)}),e.occurrences&&e.occurrences.length>0&&e.occurrences.forEach(a=>{let n=P(a,t);n&&r.push(n)});else for(let a in e){let n=P(e[a],t);n&&r.push(n)}return r}function z(e){return e&&e.val?e.val:e}function Ze(e){var a,n;let t=new Date(!e.type||e.type==="VEVENT"?((a=e.startDate)==null?void 0:a.toJSDate())||(0,b.default)(z(e.start)).toDate():(0,b.default)(z(e.start)||z(e.due)).toISOString()),r=new Date(((n=e.endDate)==null?void 0:n.toJSDate())||(!e.type||e.type==="VEVENT"?z(e.end):(0,b.default)(z(e.due)||z(e.end)).toISOString())||(0,b.default)(z(e.start)).toDate());return{startDate:t,endDate:r}}function P(e,t){var r,a,n,o,s,i,f,l;if(e&&!Array.isArray(e)){let{startDate:d,endDate:c}=Ze(e);ne(`convertEvent - event: ${JSON.stringify(e)}`);let g=e.recurrenceId;if(e.item&&(e=e.item),t.type==="ical"&&e.type===void 0||e.type&&!["VEVENT","VTODO","VALARM"].includes(e.type)||e.type==="VTODO"&&!t.includeTodo)return;((r=e.duration)==null?void 0:r.wrappedJSObject)&&delete e.duration.wrappedJSObject;let E={uid:e.uid||(0,re.v4)(),date:""};g?E.date=new Date(g.year,g.month,g.day,g.hour,g.minute,g.second).getTime().toString():E.date=d.getTime().toString(),e.duration||(e.duration=b.default.duration(c.getTime()-d.getTime()));let y={date:L(e,d,c,!0,t),eventStart:d,eventEnd:c,summary:e.summary||"",description:e.description||"",attendee:e.attendees||e.attendee,duration:typeof((a=e.duration)==null?void 0:a.toICALString)=="function"?(n=e.duration)==null?void 0:n.toICALString():e.duration.toString(),durationSeconds:typeof((o=e.duration)==null?void 0:o.toSeconds)=="function"?(s=e.duration)==null?void 0:s.toSeconds():b.default.duration(e.duration).asSeconds(),location:e.location||"",organizer:e.organizer||"",rrule:e.rrule,rruleText:(i=e.rrule)==null?void 0:i.toText(),uid:E,isRecurring:!!g||!!e.rrule,datetype:e.type==="VTODO"?"todo":"date",allDay:W(e,d,c),calendarName:null,exdate:e.exdate,recurrences:e.recurrences,categories:e.categories,alarms:[],status:e.type==="VTODO"?{completed:e.status==="COMPLETED",percent:e.completion,date:(0,b.default)(z(e.completed)).toDate()}:void 0,originalEvent:e},I=(m,u)=>{let D={};return D[m]=u,u!==void 0&&u!==""?D:{}};for(let m of Object.keys(e)){let u=e[m];(u==null?void 0:u.type)==="VALARM"&&y.alarms.push(Object.assign({},I("trigger",typeof((f=u.trigger)==null?void 0:f.toICALString)=="function"?(l=u.trigger)==null?void 0:l.toICALString():u.trigger),I("triggerParsed",(0,b.default)(d).add(b.default.duration(u.trigger)).toDate()),I("action",u.action),I("summary",u.summary),I("description",u.description),I("attendee",u.attendees||u.attendee)))}return Object.keys(y).forEach(m=>{(y[m]===void 0||y[m]===""||Array.isArray(y[m])&&Object.keys(y[m]).length===0&&y[m].length===0)&&delete y[m]}),y}}function Be(e,t){var a,n,o,s,i,f;if(e){let l=(0,b.default)(e.start).toDate(),d=(0,b.default)(e.end).toDate();ne(`convertScrapegoat - event: ${JSON.stringify(e)}`);let c=e.recurrenceId||((a=e.type)==null?void 0:a.recurring);((n=e.duration)==null?void 0:n.wrappedJSObject)&&delete e.duration.wrappedJSObject;let g=e.uid||(0,re.v4)();g+=l.getTime().toString();let E=e.duration,y=!1;if(E)/(-)?P(?:([.,\d]+)Y)?(?:([.,\d]+)M)?(?:([.,\d]+)W)?(?:([.,\d]+)D)?(?:T(?:([.,\d]+)H)?(?:([.,\d]+)M)?(?:([.,\d]+)S)?)?/.test(E)?y=b.default.duration(E).asSeconds()%86400==0:y=E.toSeconds()%86400==0;else{var r=(d.getTime()-l.getTime())/1e3;r=Number(r),y=r%86400==0}return{date:L(e,l,d,!0,t).trim(),eventStart:l,eventEnd:d,summary:e.summary||e.title||"",description:e.description||"",attendee:e.attendees,duration:typeof((o=e.duration)==null?void 0:o.toICALString)=="function"?(s=e.duration)==null?void 0:s.toICALString():e.duration,durationSeconds:typeof((i=e.duration)==null?void 0:i.toSeconds)=="function"?(f=e.duration)==null?void 0:f.toSeconds():b.default.duration(E).asSeconds(),location:e.location||"",organizer:e.organizer||"",uid:g,isRecurring:!!c,datetype:"date",allDay:y,calendarName:null,alarms:[]}}}var De=O(require("axios")),we=O(require("stream")),Qe=require("xml-js"),Ge=require("ical-expander"),Tt=require("moment"),Z=require("debug")("kalender-events:icloud");function Ee(e,t,r,a,n){var i,f;let s=new Ge({ics:a,maxIterations:1e3}).between(t.toDate(),r.toDate());Z(`process - events: ${JSON.stringify(s)}`);for(let l of j(s,n)){let d=((i=l==null?void 0:l.uid)==null?void 0:i.uid)+((f=l==null?void 0:l.uid)==null?void 0:f.date);e[d]=l}}async function Xe(e,t,r){var d;let a="YYYYMMDDTHHmms\\Z";var n=`<?xml version="1.0" encoding="utf-8" ?>

        <C:calendar-query xmlns:D="DAV:" xmlns:C="urn:ietf:params:xml:ns:caldav">

          <D:prop>

            <C:calendar-data/>

          </D:prop>

          <C:filter>

            <C:comp-filter name="VCALENDAR">

              <C:comp-filter name="VEVENT">

                <C:time-range start="${t.format(a)}" end="${r.format(a)}" />

              </C:comp-filter>

            </C:comp-filter>

          </C:filter>

        </C:calendar-query>`,o={rejectUnauthorized:e.rejectUnauthorized,url:e.url,method:"REPORT",headers:{"Content-type":"application/xml","Content-Length":n.length,"User-Agent":"calDavClient",Connection:"close",Depth:"1"}};e.username&&e.password&&(o.auth={username:e.username,password:e.password}),Z(`requestIcloudSecure - options: ${JSON.stringify(o)}`),Z(`requestIcloudSecure - xml: ${n}`);let s=await(0,De.default)(ge(pe({},o),{data:n,responseType:"stream"})),i=(d=s==null?void 0:s.data)==null?void 0:d.pipe(new we.PassThrough({encoding:"utf-8"})),f="";for await(let c of i)f+=c;let l=JSON.parse(Qe.xml2json(f,{compact:!0,spaces:0}));if(Object.keys(l).length===0)throw new Error("No data");return l}async function Se(e){let{pastview:t,preview:r}=U(e),a=await Xe(e,t,r);Z(`ICloud - json: ${JSON.stringify(a)}`);var n=[];return a&&a.multistatus&&a.multistatus.response&&(a.multistatus.response.propstat?Ee(n,t,r,a.multistatus.response.propstat.prop["calendar-data"]._cdata,e):a.multistatus.response.forEach(o=>Ee(n,t,r,o.propstat.prop["calendar-data"]._cdata,e))),n}var ve=O(require("fs")),Ie=O(require("axios")),{v4:_e}=require("uuid"),et=require("rrule").RRule,A=require("moment-timezone");function ae(e=""){return e.replace(/\\,/g,",").replace(/\\;/g,";").replace(/\\[nN]/g,`
`).replace(/\\\\/g,"\\")}function tt(e){if(e==="TRUE")return!0;if(e==="FALSE")return!1;let t=Number(e);return Number.isNaN(t)?e:t}function ie(e){let t={};for(let r of e)if(r.includes("=")){let a=r.split("=");t[a[0]]=tt(a.slice(1).join("="))}return t}function B(e){return function(t,r){let a=r[e];return Array.isArray(a)?(a.push(t),r):(typeof a=="undefined"?r[e]=t:r[e]=[a,t],r)}}function C(e){return function(t,r,a){let n=r&&r.length>0&&!(r.length===1&&(r[0]==="CHARSET=utf-8"||r[0]==="VALUE=TEXT"))?{params:ie(r),val:ae(t)}:ae(t);return B(e)(n,a)}}function rt(e,t){let r=ie(t);return e.tz||t&&r&&e&&(e.tz=r.TZID,e.tz!==void 0&&(e.tz=e.tz.replace(/^"(.*)"$/,"$1"))),e}var se=null;function Te(e){if(!se){let r=require("path");se=require(r.join(__dirname,"windowsZones.json"))}let t=se[e];return t?t.iana[0]:null}function nt(e){let t=e,r="";if(t==="tzone://Microsoft/Custom"&&(t=A.tz.guess()),t=t.replace(/^"(.*)"$/,"$1"),t&&t.includes(" ")){let a=Te(t);a&&(t=a)}if(t&&t.startsWith("(")){let a=/[+|-]\d*:\d*/;t=null,r=t.match(a)}return r===""&&(r=A.tz.names().find(a=>a===t)),r===""?t:r}function Oe(e,t){return t&&t.includes("VALUE=DATE")&&!t.includes("VALUE=DATE-TIME")||/^\d{8}$/.test(e)===!0}function at(e){return function(t,r,a){let n=Oe(t,r)?"date":"date-time";return B(e)(n,a)}}function Y(e){return function(t,r,a){let n=r.indexOf("TZID=tzone");n>=0&&(r[n]=r[n]+":"+t.split(":")[0],t=t.split(":")[1]);let o=ae(t);if(Oe(t,r)){let i=/^(\d{4})(\d{2})(\d{2}).*$/.exec(t);if(i!==null)return o=new Date(i[1],Number.parseInt(i[2],10)-1,i[3]),o.dateOnly=!0,B(e)(o,a)}let s=/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})(Z)?$/.exec(t);if(s!==null)if(s[7]==="Z")o=new Date(Date.UTC(Number.parseInt(s[1],10),Number.parseInt(s[2],10)-1,Number.parseInt(s[3],10),Number.parseInt(s[4],10),Number.parseInt(s[5],10),Number.parseInt(s[6],10))),o.tz="Etc/UTC";else if(r&&r[0]&&r[0].includes("TZID=")&&r[0].split("=")[1]){let i=r[0].split("=")[1],f="",l="";if(i==="tzone://Microsoft/Custom"&&(i=A.tz.guess(),r[0]="TZID="+i),i=i.replace(/^"(.*)"$/,"$1"),i&&i.includes(" ")){let d=Te(i);d&&(i=d,l="")}if(i&&i.startsWith("(")){let d=/[+|-]\d*:\d*/;l=i.match(d),i=null,f=l}f===""&&(f=A.tz.names().find(d=>d===i)),o=f?A.tz(t,"YYYYMMDDTHHmmss"+l,i).toDate():new Date(Number.parseInt(s[1],10),Number.parseInt(s[2],10)-1,Number.parseInt(s[3],10),Number.parseInt(s[4],10),Number.parseInt(s[5],10),Number.parseInt(s[6],10)),o=rt(o,r)}else o=new Date(Number.parseInt(s[1],10),Number.parseInt(s[2],10)-1,Number.parseInt(s[3],10),Number.parseInt(s[4],10),Number.parseInt(s[5],10),Number.parseInt(s[6],10));return B(e)(o,a)}}function it(e){return function(t,r,a){C(t,r,a);let n=t.split(";");return a[e]={lat:Number(n[0]),lon:Number(n[1])},a}}function st(e){let t=/\s*,\s*/g;return function(r,a,n){return C(r,a,n),n[e]===void 0?n[e]=r?r.split(t):[]:r&&(n[e]=n[e].concat(r.split(t))),n}}function ot(e){return function(t,r,a){let n=/\s*,\s*/g;a[e]=a[e]||[];let o=t?t.split(n):[];for(let s of o){let i=[];if(Y(e)(s,r,i),i[e])if(typeof i[e].toISOString=="function")a[e][i[e].toISOString().slice(0,10)]=i[e];else throw new TypeError("No toISOString function in exdate[name]"+i[e])}return a}}function dt(e){return Y(e)}function lt(e,t){let r=ie(t);return t&&r&&(e.type=r.FBTYPE||"BUSY"),e}function ut(e){return function(t,r,a){let n=lt({},r);a[e]=a[e]||[],a[e].push(n),C(t,r,n);let o=t.split("/");for(let[s,i]of["start","end"].entries())Y(i)(o[s],r,n);return a}}function ft(e){let t=e.indexOf(`
`,1);return t===-1?e.includes("\r")?"\r":`
`:e[t-1]==="\r"?`\r?
`:`
`}var be={BEGIN(e,t,r,a){return a.push(r),{type:e,params:t}},END(e,t,r,a){function n(o,s,i,f){if(o==="VCALENDAR"){let d,c;for(d in i)!{}.hasOwnProperty.call(i,d)||(c=i[d],typeof c=="string"&&delete i[d]);return i}let l=f.pop();if(!i.end)if(i.datetype==="date-time")i.end=i.start;else if(i.duration===void 0)i.end=A.utc(i.start).add(1,"days").toDate();else{let d={W:"weeks",D:"days",H:"hours",M:"minutes",S:"seconds"},c=i.duration.match(/-?\d+[YMWDHS]/g),g=A.utc(i.start),E=i.duration.startsWith("-")?-1:1;if(c)for(let y of c)g=g.add(Number.parseInt(y,10)*E,d[y.slice(-1)]);i.end=g.toDate()}if(i.uid){if(l[i.uid]===void 0)l[i.uid]=i,l.method&&(l[i.uid].method=l.method);else if(i.recurrenceid===void 0){let d;for(d in i)d!==null&&(l[i.uid][d]=i[d])}if(typeof i.recurrenceid!="undefined"){let d={},c;for(c in i)c!==null&&(d[c]=i[c]);if(typeof d.recurrences!="undefined"&&delete d.recurrences,l[i.uid].recurrences===void 0&&(l[i.uid].recurrences={}),typeof i.recurrenceid.toISOString=="function")l[i.uid].recurrences[i.recurrenceid.toISOString().slice(0,10)]=d;else throw new TypeError("No toISOString function in curr.recurrenceid"+i.recurrenceid)}typeof l[i.uid].rrule!="undefined"&&typeof l[i.uid].recurrenceid!="undefined"&&delete l[i.uid].recurrenceid}else{let d=_e();l[d]=i,l.method&&(l[d].method=l.method)}return l}if((e==="VEVENT"||e==="VTODO"||e==="VJOURNAL")&&r.rrule){let o=r.rrule.replace("RRULE:","");if(o=o.slice(o.lastIndexOf("FREQ=")),o.includes("DTSTART")===!1){let s=A(r.start).format("MMMM/Do/YYYY, h:mm:ss a");if(s.slice(-11)==="12:00:00 am"&&!(r.start.getTimezoneOffset()<0)){s=A(r.start).format("MMMM/Do/YYYY");let f=/^(\d{2})\/(\d{2})\/(\d{4})/.exec(s);f&&(r.start=new Date(f[3],f[1]-1,f[2]))}if(r.start&&typeof r.start.toISOString=="function")try{r.start.tz?o+=`;DTSTART;TZID=${nt(r.start.tz)}:${r.start.toISOString().replace(/[-:]/g,"")}`:o+=`;DTSTART=${r.start.toISOString().replace(/[-:]/g,"")}`,o=o.replace(/\.\d{3}/,"")}catch(i){throw new Error("ERROR when trying to convert to ISOString"+i)}else throw new Error("No toISOString function in curr.start"+r.start)}try{r.rrule=et.fromString(o)}catch(s){throw s}}return n.call(this,e,t,r,a)},SUMMARY:C("summary"),DESCRIPTION:C("description"),URL:C("url"),UID:C("uid"),LOCATION:C("location"),DTSTART(e,t,r){return r=Y("start")(e,t,r),at("datetype")(e,t,r)},DTEND:Y("end"),EXDATE:ot("exdate")," CLASS":C("class"),TRANSP:C("transparency"),GEO:it("geo"),"PERCENT-COMPLETE":C("completion"),COMPLETED:Y("completed"),CATEGORIES:st("categories"),FREEBUSY:ut("freebusy"),DTSTAMP:Y("dtstamp"),CREATED:Y("created"),"LAST-MODIFIED":Y("lastmodified"),"RECURRENCE-ID":dt("recurrenceid"),RRULE(e,t,r,a,n){return r.rrule=n,r}};function ct(e,t,r,a,n,o){return be[e]?be[e](t,r,a,n,o):/X-[\w-]+/.test(e)&&n.length>0?(e=e.slice(2),C(e)(t,r,a,n,o)):C(e.toLowerCase())(t,r,a)}function Ne(e,t,r,a,n,o){!o&&typeof r=="function"&&(o=r,r=void 0),r=r||{},a=a||[];let s=0,i=n||0;for(let f=e.length;i<f;i++){let l=e[i];for(;e[i+1]&&/[ \t]/.test(e[i+1][0]);)l+=e[i+1].slice(1),i++;l.includes("TZID=")&&!l.includes('"(')&&(l=l.replace(/"/g,""));let d=/^([\w\d-]+)((?:;[\w\d-]+=(?:(?:"[^"]*")|[^":;]+))*):(.*)$/,c=l.match(d);if(c===null)continue;c=c.slice(1);let g=c[c.length-1],E=c[0],y=c[1]?c[1].split(";").slice(1):[];if(r=ct(E,g,y,r,a,l)||{},++s>t)break}if(i>=e.length&&(r==null||delete r.type,r==null||delete r.params),o)i<e.length?setImmediate(()=>{Ne(e,t,r,a,i+1,o)}):setImmediate(()=>{o(null,r)});else return r;return null}function Q(e){let t=ft(e),r=e.split(t===`
`?/\n/:/\r?\n/);return Ne(r,r.length)}async function G(e,t){let r=await Ie.default.get(e,t);if(Math.floor(r.status/100)!==2)throw new Error(`${r.status} ${r.statusText}`);return Q(r.data)}async function Ce(e){let t=await ve.default.promises.readFile(e,"utf8");return Q(t)}var Me=O(require("url"));var J=require("@naimo84/dav"),pt=require("scrapegoat"),gt=require("ical-expander"),oe=require("debug")("kalender-events:caldav");async function Re(e){let t=new X(e),{preview:r,pastview:a}=U(e),n=[{type:"comp-filter",attrs:{name:"VCALENDAR"},children:[{type:"comp-filter",attrs:{name:"VEVENT"},children:[{type:"time-range",attrs:{start:a.format("YYYYMMDD[T]HHmmss[Z]"),end:r.format("YYYYMMDD[T]HHmmss[Z]")}}]}]}],o=new J.transport.Basic(new J.Credentials({username:e.username,password:e.password})),s=e.url,i=Me.parse(s),f=i.protocol+"//"+i.host+"/",l=await J.createAccount({server:s,xhr:o,loadCollections:!0,loadObjects:!0});if(!l.calendars)throw"CalDAV -> no calendars found.";let d=[];for(let y of l.calendars)if(mt(e.calendar,y.displayName)){if(e.includeTodo){let I=await J.syncCalendar(y,{xhr:o,filters:[{type:"comp-filter",attrs:{name:"VCALENDAR"},children:[{type:"comp-filter",attrs:{name:"VTODO"}}]}]});for(let m of I.objects){let u=m.calendarData;if(u){let D=await Q(u);for(var c in D)if(D[c].type==="VTODO"){var g=P(D[c],e);if(g){g.calendarName=y.displayName;let k=`${g.uid.uid+g.uid.date}`;d[k]=g}}}}}if(e.includeEvents){let I=await J.listCalendarObjects(y,{xhr:o,filters:n});for(let m of I){let u=m.calendarData;if(u){let k=new gt({ics:u,maxIterations:100}).between(a.toDate(),r.toDate());j(k,e).forEach(w=>{if(oe(`caldav - ical: ${JSON.stringify(w)}`),w){w.calendarName=y.displayName;let h=`${w.uid.uid+w.uid.date}`;d[h]=w}})}else if(m.calendar.objects){for(let D of m.calendar.objects)if(D.data&&D.data.href){let k=f+D.data.href,w={},h=e.username,N=e.password;if(h&&N){var E="Basic "+Buffer.from(h+":"+N).toString("base64");w={headers:{Authorization:E}}}let v=await G(k,w);for(var c in v){var g=t.convertEvent(v[c]);if(g){g.calendarName=y.displayName;let T=`${g.uid.uid+g.uid.date}`;d[T]=g}}}}}}}return d}function mt(e,t){return!e||!t||!t.length||e.toLowerCase().split(",").indexOf(t.toLowerCase())>=0}async function ke(e){oe("Fallback");let r=await new pt({auth:{user:e.username,pass:e.password},uri:encodeURI(e.url).replace("@","%40"),rejectUnauthorized:e.rejectUnauthorized,headers:{"Content-Type":"application/xml"}}).getAllEvents();return oe(`Fallback - data: ${JSON.stringify(r)}`),j(r,e)}var je=O(require("node-cache"));var xe=O(require("fs")),Ae=O(require("path"));async function de(e){try{let t=await xe.promises.readFile(e.toString(),"utf-8");return JSON.parse(t)}catch{}}async function Ye(){let e=await de((0,Ae.join)(__dirname,"../../package.json"));return e?e.version:"not found"}var ze=O(require("path")),M=require("moment"),S=require("debug")("kalender-events"),Pe=require("rrule").RRule,le=require("cloneextend"),X=class{constructor(t){this.config={};t&&(this.config=t),this.calcPrePastView(),this.cache=this.config.cache?this.config.cache:new je.default}calcPrePastView(){this.config.pastview===void 0&&(this.config.pastview=10),this.config.pastviewUnits===void 0&&(this.config.pastviewUnits="days"),this.config.preview===void 0&&(this.config.preview=10),this.config.previewUnits===void 0&&(this.config.previewUnits="days"),this.config.pastviewUnits=this.config.pastviewUnits.toLocaleLowerCase(),this.config.previewUnits=this.config.previewUnits.toLocaleLowerCase()}addOffset(t,...r){return r.length==1?new Date(t.getTime()+parseInt(r)*60*1e3):M(t).add(r[0],r[1]).toDate()}countdown(t){var r=(new Date(t).getTime()-new Date().getTime())/1e3;r=Number(r);var a=Math.floor(r/(3600*24)),n=Math.floor(r%(3600*24)/3600),o=Math.floor(r%3600/60),s=Math.floor(r%60);return{days:a,hours:n,minutes:o,seconds:s}}async getEvents(t){var r,a;try{let n=await de((0,ze.join)(__dirname,"../package.json"));S(`packageJson version: ${n==null?void 0:n.version}`),t&&(this.config=Object.assign(this.config,t)),this.config.includeEvents=this.config.eventtypes!==void 0&&this.config.eventtypes!==""?((r=this.config.eventtypes)==null?void 0:r.indexOf("events"))>=0:!0,this.config.includeTodo=this.config.eventtypes!==void 0&&this.config.eventtypes!==""?((a=this.config.eventtypes)==null?void 0:a.indexOf("todos"))>=0:this.config.includeTodo,this.calcPrePastView();let o=await this.getCal(),s=new Date;t&&t.now&&(s=M(t.now).toDate());let{preview:i,pastview:f}=U(this.config);S(`getEvents - pastview: ${f}`),S(`getEvents - preview: ${i}`);let l=this.processData(o,s,f.toDate(),i.toDate());return S(`getEvents - processedData: ${JSON.stringify(l)}`),this.config.usecache&&this.cache&&o&&this.cache.set("events",l),l}catch(n){if(this.config.usecache&&this.cache)return this.cache.get("events");throw n}}async getCal(){var r,a,n,o;if(this.config.type&&this.config.type==="icloud"){S("getCal - icloud");try{return await Se(this.config)}catch(s){throw S(s),s}}else if(this.config.type&&this.config.type==="caldav"){S("getCal - caldav");try{return await Re(this.config)}catch(s){S(`getCal - caldav - get calendar went wrong. Error Message: ${s}`),S("getCal - caldav - using fallback");try{return await ke(this.config)}catch(i){throw`caldav - get calendar went wrong. Error Message: ${i}`}}}else if(S("getCal - ical"),((a=(r=this.config)==null?void 0:r.url)==null?void 0:a.match(/^webcal:\/\//))&&(this.config.url=this.config.url.replace("webcal","https")),(o=(n=this.config)==null?void 0:n.url)==null?void 0:o.match(/^https?:\/\//)){let s={},i=this.config.username,f=this.config.password;if(i&&f){var t="Basic "+Buffer.from(i+":"+f).toString("base64");s={headers:{Authorization:t}}}let l=await G(this.config.url,s);return S(l),await j(l,this.config)}else{if(!this.config.url)throw"URL/File is not defined";let s=await Ce(this.config.url);return S(s),await j(s,this.config)}}processRRule(t,r,a){var m,u;var n=t.eventEnd.getTime()-t.eventStart.getTime(),o=Pe.parseString(t.rrule.toString());o.dtstart=this.addOffset(t.eventStart,-F(t.eventStart)),o.until&&(o.until=this.addOffset(o.until,-F(o.until))),S("options:"+JSON.stringify(o));var s=new Pe(o);S("processRRule - RRule event:"+t.summary+"; start:"+((m=t.eventStart)==null?void 0:m.toString())+"; preview:"+r.toString()+"; today:"+a+"; rule:"+JSON.stringify(s));var i=[];try{i=s.between(a,r,!0)}catch(D){throw"Issue detected in RRule, event ignored; "+D.stack+`
RRule object: `+JSON.stringify(s)+`
preview: `+r+`
string: `+t.rrule.toString()+`
options: `+JSON.stringify(o)}S("processRRule - dates:"+JSON.stringify(i));let f=[];if(i.length>0)for(var l=0;l<i.length;l++){var d=le.clone(t),c=i[l];d.eventStart=this.addOffset(c,F(c));var g=new Date(c.getTime()+n);if(d.eventEnd=this.addOffset(g,F(g)),d.alarms&&d.alarms.length>0)for(let D of d.alarms)D.triggerParsed=M(d.eventStart).add(M.duration(D.trigger).asSeconds(),"seconds").toDate();S("processRRule - "+l+": Event ("+JSON.stringify(d.exdate)+"):"+d.eventStart.toString()+" "+d.eventEnd.toString());var E=!0;if(d.exdate){for(var y in d.exdate)if(d.exdate[y]&&typeof d.exdate[y].getTime=="function"&&d.exdate[y].getTime()===d.eventStart.getTime()){E=!1,S("processRRule - "+l+": sort out");break}}if(E&&t.recurrences)for(var I in t.recurrences){let D=t.recurrences[I].recurrenceid;D&&typeof D.getTime=="function"&&D.getTime()===((u=d.eventStart)==null?void 0:u.getTime())&&(d=P(t.recurrences[I],this.config),S("processRRule - "+l+": different recurring found replaced with Event:"+d.eventStart+" "+d.eventEnd))}if(E){let D=L(d,d.eventStart,d.eventEnd,!0,this.config);d.date=D.trim(),f.push(d)}}else if(t.recurrences){for(var I in t.recurrences)if(t.recurrences[I].recurrenceid){let w=le.clone(t.recurrences[I]),h=P(w,this.config);if((h==null?void 0:h.eventStart)>=a&&(h==null?void 0:h.eventStart)<=r||(h==null?void 0:h.eventEnd)>=a&&(h==null?void 0:h.eventEnd)<=r){let N=L(h,h==null?void 0:h.eventStart,h==null?void 0:h.eventEnd,!0,this.config);h.date=N.trim(),f.push(h)}}}return f}processData(t,r,a,n){let o=[];return this.processDataRev(t,r,a,n,o),o}processDataRev(t,r,a,n,o){var s=0;for(var i in t){let f=t[i];if(delete t[i],S(`processDataRev - event: ${JSON.stringify(f)}`),f!==void 0&&f.eventStart){if(f.eventEnd||(f.eventEnd=le.clone(f.eventStart),!f.eventStart.getHours()&&!f.eventStart.getMinutes()&&!f.eventStart.getSeconds()&&f.eventEnd.setDate(f.eventEnd.getDate()+1)),f.rrule===void 0)this.checkDates(f,n,a,r," ",o);else{let l=this.processRRule(f,n,a);for(let d of l)this.checkDates(d,n,a,r,f.rrule,o)}if(++s>100)break}}if(Object.keys(t).length)this.processDataRev(t,r,a,n,o);else return}filterOutput(t){let r=!1,a=t.summary;return this.config.filterProperty&&(a=t[this.config.filterProperty]),a?this.config.trigger=="match"?r=this.checkRegex(a):this.config.trigger=="nomatch"?r=!this.checkRegex(a):r=!0:this.config.trigger=="always"&&(r=!0),r}checkRegex(t){if(this.config.filterProperty&&this.config.filterProperty=="attendee"){let r=new RegExp(this.config.filter||"");if(Array.isArray(t)){for(let a of t)if(a.jCal&&r.test(a.jCal[1].cn)||a.params&&r.test(a.params.CN))return!0}else return r.test(t.params.CN)}else if(this.config.filterProperty&&this.config.filterProperty.indexOf("event")>=0){if(t instanceof Date)switch(this.config.filterOperator){case"before":if(M(t).isBefore(M(this.config.filter,"YYYY-MM-DD_hh:mm:ss")))return!0;break;case"after":if(M(t).isAfter(M(this.config.filter,"YYYY-MM-DD_hh:mm:ss")))return!0;break;case"between":if(M(t).isBetween(M(this.config.filter,"YYYY-MM-DD_hh:mm:ss"),M(this.config.filter2,"YYYY-MM-DD_hh:mm:ss")))return!0;break}}else{let r=new RegExp(this.config.filter||"");if(Array.isArray(t)){for(let a of t)if(r.test(a))return!0}else return t instanceof Object&&t.hasOwnProperty("val")?r.test(t.val):r.test(t)}return!1}checkDates(t,r,a,n,o,s){var i=!1;if(!t.eventStart)return;t.eventEnd||(t.eventEnd=t.eventStart),t.eventStart=new Date(t.eventStart),t.eventEnd=new Date(t.eventEnd),!t.eventStart.getHours()&&!t.eventStart.getMinutes()&&!t.eventStart.getSeconds()&&!t.eventEnd.getHours()&&!t.eventEnd.getMinutes()&&!t.eventEnd.getSeconds()&&(t.eventEnd.getTime()==t.eventStart.getTime()&&t.datetype=="date"&&t.eventEnd.setDate(t.eventEnd.getDate()+1),t.eventEnd.getTime()!==t.eventStart.getTime()&&(i=!0)),this.filterOutput(t)&&(S("checkDates - event: "+JSON.stringify(t)),delete t.recurrences,delete t.exdate,i?(t.eventStart<r&&t.eventStart>=a||t.eventEnd>a&&t.eventEnd<=r||t.eventStart<a&&t.eventEnd>a)&&(ee(s,t),S("checkDates - Event (full day) added : "+JSON.stringify(o)+" "+t.summary+" at "+t.eventStart)):(t.eventStart>=a&&t.eventStart<r||t.eventEnd>=n&&t.eventEnd<=r||t.eventStart<n&&t.eventEnd>n)&&(ee(s,t),S("checkDates - Event with time added: "+JSON.stringify(o)+" "+t.summary+" at "+t.eventStart)))}};function yt(){return Ye()}var qt=require("node-cache");0&&(module.exports={KalenderEvents,getVersion});
//# sourceMappingURL=index.js.map
